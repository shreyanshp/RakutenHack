{% extends "base.html" %}

{% block content %}
<div class="row">
  <div class="col-md-4 order-md-2 mb-4">
    <h4 class="d-flex justify-content-between align-items-center mb-3">
      <span class="text-muted">{{ user.name }}</span>
      <span id="num_items" class="badge badge-danger badge-pill"></span>
    </h4>
    <ul id="cartlist" class="list-group mb-3">
      <li class="list-group-item d-flex justify-content-between lh-condensed">
        <div><h6 class="my-0">Curent balance</h6></div>
        <span class="text-muted">{{ user.point | int }}</span>
      </li>
      <!-- The content will be generated by buildCartList() -->
    </ul>

    <form class="card p-2" method="post" action="/record">
      <input id="cart" name="cart" type="hidden" value="">
      <input id="amount" name="amount" type="hidden" value="">
      <button id="submit" type="submit" class="btn btn-secondary">Pay / Charge</button>
    </form>
  </div>

  <div class="col-md-8 order-md-1">
    <ul class="nav nav-pills mb-3" id="pills-tab" role="tablist">
      {% for cat in category %}
      <li class="nav-item">
        <a class="nav-link{% if loop.first %} active{% endif %}" id="pills-{{ cat.cid }}-tab" data-toggle="pill" href="#pills-{{ cat.cid }}" role="tab" aria-controls="pills-{{ cat.cid }}" aria-selected="true">{{ cat.title }}</a>
      </li>
      {% endfor %}
    </ul>

    <div class="tab-content" id="pills-tabContent">
      {% for cat in category %}
      <div class="tab-pane fade{% if loop.first %} show active{% endif %}" id="pills-{{ cat.cid }}" role="tabpanel" aria-labelledby="pills-{{ cat.cid }}-tab">
        {% if cat.cid == 'charge' %}
        <div class="alert alert-primary" role="alert">
          The money box should have {{ bank }} yen.
        </div>
        {% endif %}
        <div class="card-columns">
          {% for item in catalog if item.category == cat.cid %}
          <div class="card">
            <a href="#" onclick="add('{{ item.jan }}');">
              {% if item.image %}
                <img class="card-img-top" src="/static/{{ item.image }}" alt="{{ item.title }}">
              {% else %}
                <img class="card-img-top" src="/static/{{ item.jan }}.jpg" alt="{{ item.title }}">
              {% endif %}
            </a>
            <div class="card-body">
              <h6 class="card-title text-center"><a href="#" onclick="add('{{ item.jan }}');">{{ item.name }}</a></h6>
              <div class="card-text d-flex justify-content-between">
                <div>
                  {% if 0 < item.stocks %}
                  <span id="item-{{ item.jan }}-stocks" class="badge badge-secondary badge-pill">
                  {% else %}
                  <span id="item-{{ item.jan }}-stocks" class="badge badge-danger badge-pill">
                  {% endif %}
                    {{ item.stocks }}
                  </span>
                </div>
                <div class="text-muted">{{ item.price | int }}</div>
              </div>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
      {% endfor %}
    </div>
  </div>
</div>
{% endblock %}

{% block js %}
<script>
  var cart = [];
  var point = {{ user.point }};
  var category = {{ category | tojson | safe }};
  var catalog = {{ catalog | tojson | safe}};
  
  function getItem(jan)
  {
    for (var i = 0; i < catalog.length; ++i) {
      if (catalog[i]['jan'] == jan) {
        return catalog[i];
      }
    }
    return null;
  }

  function getNumStocks(jan)
  {
    var n = 0;
    item = getItem(jan);
    if (item != null) {
      n = item['stocks'];
      for (var i = 0; i < cart.length; ++i) {
        if (cart[i] == jan) --n;
      }
    }
    return n;
  }

  function updateNumStocks(jan, n)
  {
    $('#item-' + jan + '-stocks').text(n);
  }

  function add(jan)
  {
    n = getNumStocks(jan);
    // Put the item in the cart only when we have an enough number of stocks.
    if (0 < n) {
      cart.push(jan);
      updateNumStocks(jan, n-1);
      buildCartList();
    }
  }

  function remove(i)
  {
    var jan = cart[i];
    var n = getNumStocks(jan);
    cart.splice(i, 1);
    updateNumStocks(jan, n+1);
    buildCartList();
  }

  function buildCartList()
  {
    var html = "";
    var total = 0;

    html += '<li class="list-group-item d-flex justify-content-between">';
    html += '<span>Current balance</span>';
    html += '<strong>{{ user.point | int }}</strong>';
    html += '</li>';

    for (i = 0; i < cart.length; ++i) {
      var jan = cart[i];
      var item = getItem(jan);

      total += item['price']
      html += '<li class="list-group-item d-flex justify-content-between lh-condensed">';
      html += '<div><h6 class="my-0">';
      html += '<a href="#" onclick="remove(' + i + ')">';
      html += '<i class="fas fa-trash-alt"></i></a> ';
      html += item['name'];
      html += '</h6></div>';
      html += '<span class="text-muted">' + item['price'] + '</span>';
      html += '</li>';
    }
    var next_balance = point + total;

    html += '<li class="list-group-item d-flex justify-content-between">';
    html += '<span>Balance forward</span>';
    html += '<strong>' + next_balance + '</strong>';
    html += '</li>';

    $('#cartlist').html(html);
    $('#num_items').text(cart.length);
    $('#cart').val(JSON.stringify(cart));
    $('#amount').val(total);
    $('#submit').prop('disabled', (next_balance < 0 || 1500 <= next_balance));
  }
  buildCartList();
</script>    
{% endblock %}