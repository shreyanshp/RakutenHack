{% extends "base.html" %}

{% block content %}
<div class="row">
  <div class="col-md-4 order-md-2 mb-4">
    <h4 class="d-flex justify-content-between align-items-center mb-3">
      <span class="text-muted">
        <button type="button" class="btn btn-primary" onclick="update();"><i class="fas fa-sync-alt"></i></button>
         Items</span>
      <span id="num_items" class="badge badge-secondary badge-pill"></span>
    </h4>
    <ul id="cart" class="list-group mb-3">
      <!-- The content will be generated by buildCart() -->
    </ul>

    <form class="card p-2" method="post" action="/register_stock">
      <input id="items" name="items" type="hidden" value="">
      <button type="submit" class="btn btn-secondary">Register stock</button>
    </form>
  </div>

  <div class="col-md-8 order-md-1">
    <ul class="nav nav-pills mb-3" id="pills-tab" role="tablist">
      {% for cat in category %}
      <li class="nav-item">
        <a class="nav-link{% if loop.first %} active{% endif %}" id="pills-{{ cat.cid }}-tab" data-toggle="pill" href="#pills-{{ cat.cid }}" role="tab" aria-controls="pills-{{ cat.cid }}" aria-selected="true">{{ cat.title }}</a>
      </li>
      {% endfor %}
    </ul>

    <div class="tab-content" id="pills-tabContent">
      {% for cat in category %}
      <div class="tab-pane fade{% if loop.first %} show active{% endif %}" id="pills-{{ cat.cid }}" role="tabpanel" aria-labelledby="pills-{{ cat.cid }}-tab">
        <div class="card-columns">
          {% for item in catalog if item.category == cat.cid %}
          {% set prefix = "item-" ~ item.jan %}
          <div class="card">
            <img class="card-img-top" src="/static/{{ item.jan }}.jpg" alt="{{ item.title }}">
            <div class="card-body">
              <h6 class="card-title text-center">{{ item.name }}</h6>
              <p class="card-text">
                <div class="input-group input-group-sm mb-3">
                    <div class="input-group-prepend">
                      <span class="input-group-text" id="inputGroup-sizing-sm">Cost: </span>
                    </div>
                    <input type="number" id="{{ prefix }}-cost" class="form-control text-right" aria-label="Small" aria-describedby="inputGroup-sizing-sm" min="0" step="1" value="{{ item.cost }}">
                </div>
                <div class="input-group input-group-sm mb-3">
                    <div class="input-group-prepend">
                      <span class="input-group-text" id="inputGroup-sizing-sm">Quantity: </span>
                    </div>
                    <input type="number" id="{{ prefix }}-quantity" class="form-control text-right" aria-label="Small" aria-describedby="inputGroup-sizing-sm" min="0" step="1" value="0">
                </div>
                <div class="input-group input-group-sm mb-3">
                    <div class="input-group-prepend">
                      <span class="input-group-text" id="inputGroup-sizing-sm">Divide: </span>
                    </div>
                    <input type="number" id="{{ prefix }}-divide" class="form-control text-right" aria-label="Small" aria-describedby="inputGroup-sizing-sm" min="0" step="1" value="{{ item.divide }}">
                </div>
              </p>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
      {% endfor %}
    </div>
  </div>
</div>
{% endblock %}

{% block js %}
<script>
  var category = {{ category | tojson | safe }};
  var catalog = {{ catalog | tojson | safe}};

  function getItem(jan)
  {
    for (var i = 0; i < catalog.length; ++i) {
      if (catalog[i]['jan'] == jan) {
        return catalog[i];
      }
    }
    return null;
  }

  function update()
  {
    var cart = [];
    var html = "";
    var total = 0;
    var num_items = 0;

    $('input[id$="-cost"]').each(function() {
      var e_cost = $(this);
      var idstr = e_cost.attr('id');
      var jan = idstr.substr(5, idstr.length - 10);
      var e_quantity = $('#item-' + jan + '-quantity');
      var e_divide = $('#item-' + jan + '-divide');
      var cost = parseInt(e_cost.val(), 10);
      var quantity = parseInt(e_quantity.val(), 10);
      var divide = parseInt(e_divide.val(), 10);

      if (0 < cost && 0 < quantity && 0 < divide) {
        var item = getItem(jan);
        var amount = cost * quantity;

        cart.push({
          jan: item['jan'],
          cost: cost,
          quantity: quantity,
          divide: divide
        });

        html += '<li class="list-group-item d-flex justify-content-between lh-condensed">';
        html += '<div><h6 class="my-0">';
        html += item['name'];
        html += '</h6></div>';
        html += '<span class="text-muted">' + amount + '</span>';
        html += '</li>';

        total += amount;
        num_items += quantity;
      }
    });

    html += '<li class="list-group-item d-flex justify-content-between">';
    html += '<span>Total</span>';
    html += '<strong>' + total + '</strong>';
    html += '</li>';

    $('input[type=number]').on('change')
    $('#cart').html(html);
    $('#num_items').text(num_items);
    $('#items').val(JSON.stringify(cart));
  }
  update();
</script>    
{% endblock %}